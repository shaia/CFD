name: CUDA GPU Tests

on:
  push:
    branches: [master, main]
    paths:
      - 'lib/src/solvers/gpu/**'
      - 'lib/include/cfd/solvers/solver_gpu.h'
      - 'tests/solvers/test_solver_gpu.c'
      - '.github/workflows/cuda-tests.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'lib/src/solvers/gpu/**'
      - 'lib/include/cfd/solvers/solver_gpu.h'
      - 'tests/solvers/test_solver_gpu.c'
      - '.github/workflows/cuda-tests.yml'
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  CTEST_OUTPUT_ON_FAILURE: 1

jobs:
  # Build and test with CUDA enabled (CPU fallback - no actual GPU)
  cuda-build-cpu-fallback:
    name: CUDA Build (CPU Fallback)
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:12.2.0-devel-ubuntu22.04

    steps:
      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y build-essential cmake git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure CMake with CUDA
        run: |
          mkdir -p build
          cd build
          cmake .. -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCFD_ENABLE_CUDA=ON \
            -DBUILD_TESTS=ON \
            -DBUILD_EXAMPLES=OFF

      - name: Build
        run: |
          cd build
          cmake --build . --parallel $(nproc)

      - name: Verify CUDA compilation
        run: |
          cd build
          echo "Checking for CUDA symbols in static library..."
          # Library is built as static (.a) by default
          if nm -C lib/libcfd_library.a 2>/dev/null | grep -q "gpu"; then
            echo "✅ GPU symbols found in library"
            nm -C lib/libcfd_library.a | grep -i gpu | head -10
          else
            echo "❌ GPU symbols NOT found"
            echo "Library contents:"
            nm -C lib/libcfd_library.a | head -30
            exit 1
          fi

      - name: Run GPU tests (CPU fallback mode)
        run: |
          cd build
          echo "Running GPU tests without actual GPU hardware..."
          ./test_solver_gpu 2>&1 | tee gpu_test_output.txt || true

          if grep -q "test_gpu_config_defaults.*PASS" gpu_test_output.txt; then
            echo "✅ GPU config defaults test passed"
          fi

      - name: Generate summary
        run: |
          echo "## CUDA Build (CPU Fallback) Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **CUDA Version:** 12.2" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** Release" >> $GITHUB_STEP_SUMMARY
          echo "- **GPU Hardware:** None (testing fallback behavior)" >> $GITHUB_STEP_SUMMARY

  # Build without CUDA (pure CPU mode)
  cpu-only-build:
    name: CPU-Only Build (No CUDA)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Configure CMake without CUDA
        run: |
          mkdir -p build
          cd build
          cmake .. -G "Unix Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCFD_ENABLE_CUDA=OFF \
            -DBUILD_TESTS=ON \
            -DBUILD_EXAMPLES=OFF

      - name: Build
        run: |
          cd build
          cmake --build . --parallel $(nproc)

      - name: Check CUDA is disabled
        run: |
          cd build
          echo "Verifying CUDA is disabled in build..."
          # Check that CUDA symbols are NOT present in static library
          if nm -C lib/libcfd_library.a 2>/dev/null | grep -q "cudart"; then
            echo "❌ Library incorrectly contains CUDA runtime symbols"
            exit 1
          else
            echo "✅ Library does not contain CUDA runtime symbols"
          fi

      - name: Run all tests
        run: |
          cd build
          ctest --output-on-failure

      - name: Run GPU tests (should report no GPU)
        run: |
          cd build
          echo "Running GPU tests with CUDA disabled..."
          ./test_solver_gpu 2>&1 | tee gpu_test_output.txt
          grep -E "(PASS|FAIL|Skipping)" gpu_test_output.txt || true

      - name: Generate summary
        run: |
          echo "## CPU-Only Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **CUDA:** Disabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** Release" >> $GITHUB_STEP_SUMMARY

  # Windows CUDA build test
  windows-cuda-build:
    name: Windows CUDA Build
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.3

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.16
        id: cuda-toolkit
        with:
          cuda: '12.4.0'
          method: 'network'

      - name: Configure CMake with CUDA
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCFD_ENABLE_CUDA=ON `
            -DBUILD_TESTS=ON `
            -DBUILD_EXAMPLES=OFF
        shell: pwsh

      - name: Build
        run: |
          cd build
          cmake --build . --config Release --parallel
        shell: pwsh

      - name: Verify CUDA compilation
        run: |
          cd build
          Write-Host "Build completed successfully with CUDA support"
          Get-ChildItem -Recurse -Filter "*.dll" | Select-Object FullName
        shell: pwsh

      - name: Run GPU tests (CPU fallback)
        run: |
          cd build
          Write-Host "Running GPU tests (no GPU hardware available)..."
          .\Release\test_solver_gpu.exe 2>&1 | Tee-Object -FilePath gpu_test_output.txt
        shell: pwsh
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## Windows CUDA Build Summary" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "- **CUDA Version:** ${{ steps.cuda-toolkit.outputs.cuda }}" >> $env:GITHUB_STEP_SUMMARY
          echo "- **Compiler:** MSVC" >> $env:GITHUB_STEP_SUMMARY
          echo "- **Architecture:** x64" >> $env:GITHUB_STEP_SUMMARY
        shell: pwsh

  # Status check
  cuda-test-status:
    name: CUDA Test Status
    runs-on: ubuntu-latest
    needs: [cuda-build-cpu-fallback, cpu-only-build, windows-cuda-build]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## CUDA Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CUDA Build (CPU Fallback) | ${{ needs.cuda-build-cpu-fallback.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CPU-Only Build | ${{ needs.cpu-only-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows CUDA Build | ${{ needs.windows-cuda-build.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.cuda-build-cpu-fallback.result }}" == "success" && \
                "${{ needs.cpu-only-build.result }}" == "success" && \
                "${{ needs.windows-cuda-build.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All CUDA tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Some CUDA tests failed!**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
